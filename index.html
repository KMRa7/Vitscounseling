<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>パーソナルカラー簡易診断｜ステップ式</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#df9b9b; --brand-200:#ffe2e2; --brand-300:#f6c8c8;
      --ok:#10b981;
      --radius:16px; --shadow:0 10px 30px rgba(15,23,42,.08);
      --safe:env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0; font-family:'Inter','Noto Sans JP',sans-serif; background:linear-gradient(180deg,var(--bg) 0%,#fff 100%); color:var(--ink); font-size:16px}
    .wrap{max-width:860px; margin:0 auto; padding:16px 14px calc(148px + var(--safe))}
    .card{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; position:relative}
    .card::before{content:""; position:absolute; inset:0 0 auto 0; height:6px; background:linear-gradient(90deg,var(--brand-200),var(--brand-300)); border-radius:16px 16px 0 0}
    h1{margin:8px 0 4px; font-size:clamp(20px,5vw,26px)}
    .lead{color:var(--muted); margin:0 0 12px; font-size:14px; line-height:1.6}
    .stepper{display:flex; gap:6px; align-items:center; margin:6px 0 12px}
    .dot{width:8px; height:8px; border-radius:50%; background:#e2e8f0; border:1px solid #cbd5e1}
    .dot.active{background:var(--brand); border-color:var(--brand)}
    .section-title{font-weight:700; font-size:17px; margin:8px 0 10px}
    .grid-letters{display:grid; gap:12px; grid-template-columns:1fr}
    @media (min-width:640px){ .grid-letters{grid-template-columns:repeat(2,1fr)} }
    .letter-box{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff}
    .letter-head{display:flex; align-items:center; gap:10px; margin-bottom:10px}
    .letter-badge{display:inline-grid; place-items:center; width:28px; height:28px; border-radius:10px; background:#f1f5f9; border:1px solid #e2e8f0; font-weight:700}
    .icon-img{width:72px; height:72px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; display:inline-grid; place-items:center; overflow:hidden}
    .icon-img img{width:100%; height:100%; object-fit:contain}
    .swatch{width:28px; height:28px; border-radius:8px; border:1px solid #e5e7eb}
    .check{display:flex; gap:10px; align-items:center; margin:10px 0; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; transition:border-color .15s, box-shadow .15s, background .15s}
    .check:active{background:#fafafa}
    .check input{appearance:none; -webkit-appearance:none; outline:none; margin:0; width:24px; height:24px; border:2px solid #cbd5e1; border-radius:8px; display:grid; place-items:center; flex:0 0 24px; background:#fff}
    .check input::after{content:""; width:12px; height:12px; border-radius:4px; transform:scale(0); transition:transform .15s ease; background:var(--ok)}
    .check input:checked{border-color:var(--ok)}
    .check input:checked::after{transform:scale(1)}
    .check span{line-height:1.5}
    .check:has(input:checked){ border-color:rgba(16,185,129,.6); box-shadow:0 0 0 4px rgba(16,185,129,.12) }
    /* 数字ステッパー：タップ不可の見た目 */
    .num:disabled,
    .num.locked{
      opacity:.45;
      background:#f1f5f9;
      color:#94a3b8;
      border-color:#e2e8f0;
      cursor:not-allowed;
    }

    /* 結果は画像のみ表示 */
    .result{display:none; margin-top:12px}
    .hero-img{margin-top:12px; border-radius:14px; border:1px solid var(--line); overflow:hidden}
    .hero-img img{width:100%; height:auto; display:block}

    .nav{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
    .btn{cursor:pointer; min-height:48px; padding:14px 18px; border-radius:12px; border:1px solid var(--line); background:#fff; font-weight:700; width:100%; position:relative; z-index:1}
    .btn.primary{background:linear-gradient(180deg,var(--brand),#c57f7f); color:#fff; border-color:#c57f7f}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    #navBar{position:fixed; left:0; right:0; bottom:0; z-index:9999; background:#fff; border-top:1px solid var(--line); box-shadow:0 -10px 30px rgba(15,23,42,.06); padding:12px 12px calc(12px + var(--safe))}
    #navBar .row{display:grid; grid-template-columns:1fr 1fr; gap:10px; max-width:860px; margin:0 auto}
    @media (min-width:640px){ #navBar .row{grid-template-columns:160px 1fr} }
    @media (min-width:960px){ .wrap{padding-bottom:160px} }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card" id="app" aria-live="polite">
      <h1>パーソナルカラー簡易診断（ステップ式）</h1>
      <p class="lead">各ステップで <b>A/B/C/D</b> の中から<strong>複数チェック可</strong>。すべて回答後にタイプ判定します。</p>

      <div class="stepper" id="stepper"></div>
      <div id="questionView"></div>

      <!-- 結果は画像のみ -->
      <div class="result" id="resultView">
        <div class="hero-img" id="heroImg" aria-hidden="true"></div>
        <div class="nav">
          <button class="btn" id="btnRestart">やり直す</button>
          <button class="btn primary" id="btnShareLine">結果画像をLINEで送る</button>
        </div>
      </div>
    </section>
  </main>

  <!-- 下部固定ナビ -->
  <nav id="navBar" aria-label="操作ナビ">
    <div class="row" id="navBtns">
      <button class="btn" id="btnPrev">戻る</button>
      <button class="btn primary" id="btnNext" disabled>次へ</button>
    </div>
  </nav>

  <script>
    /* ===================== 設定 ===================== */
    const LETTER_TO_SEASON = { A: 'WINTER', B: 'SUMMER', C: 'AUTUMN', D: 'SPRING' };
    const RESULT_IMAGES = {
      SPRING: 'https://www.dropbox.com/scl/fi/6x43wuq7lf3s3ppyfpabu/4.png?rlkey=88ju2e5c659hg8fns3u24avvg&dl=1',
      SUMMER: 'https://www.dropbox.com/scl/fi/9esqh65fomu9za7q43j4k/2.png?rlkey=fj29mxutr611k1j1j9j8szng6&dl=1',
      AUTUMN: 'https://www.dropbox.com/scl/fi/d4e2z1y2z1s0fzohkrz9c/3.png?rlkey=lcg5lv3z6dcqxi16edcdibgsi&dl=1',
      WINTER: 'https://www.dropbox.com/scl/fi/m1iqpihu2dr8q9b4hnru4/1.png?rlkey=ldem7h7sai3fajnw6xfkaz096&dl=1',
    };

    const SECTIONS = [
      { id:'skin', title:'Ⅰ 肌の色・印象は？',
        letters:{
          A:{ swatch:'#f2d7c3', items:['色白、ほおの赤みが少ない','やや赤みを帯びている','ツヤがある','メナードのファンデーション 22・23・51・52を使用'] },
          B:{ swatch:'#f3c7c3', items:['ピンクベージュ、ピンクみを帯びている','透けるように白い','ツヤが少ない、パウダリーな印象','メナードのファンデーション 22・23・51・52を使用'] },
          C:{ swatch:'#e6c39a', items:['クリーム色、黄みが強い','赤みがない、くすみがち','陶器のようななめらかな質感','メナードのファンデーション 41・41Y・44・52Yを使用'] },
          D:{ swatch:'#e8dcd1', items:['アイボリーベージュ、黄みがある','小麦肌、ツヤがある','血色がよい、ほほが赤くなりやすい','メナードのファンデーション 41・41Y・44・52Yを使用'] }
        }
      },
      { id:'beigegray', title:'Ⅱ ベージュとグレーの洋服で得意なのは？',
        letters:{
          A:{ img:'https://www.dropbox.com/scl/fi/f45scwhiw1joxcowsg22g/1.png?rlkey=ohm9bn5end0hzocu3ctman2o7&dl=1', items:['ダークなグレー（顔の印象をはっきりと見せる'] },
          B:{ img:'https://www.dropbox.com/scl/fi/0roqzj9g4cadbc7d79c4s/2.png?rlkey=gp833m25rql6cavmt3i9a3vnw&dl=1', items:['明るいグレーや青みの強いグレー（肌がキレイに見える）'] },
          C:{ img:'https://www.dropbox.com/scl/fi/6gn3quc7n0tuepa3yjtht/3.png?rlkey=r94s81ov3cxq93o4n0q8j9ujo&dl=1', items:['落ち着いたベージュやブラウン（地味になったり老けたりしない）'] },
          D:{ img:'https://www.dropbox.com/scl/fi/88bit1bexy12jwjy6vtz1/4.png?rlkey=m0j9ykut4940c7b85o2qmr2c1&dl=1', items:['明るいベージュ（顔色が良く見える）'] }
        }
      },
      { id:'eyes', title:'Ⅲ 瞳の色・印象は？',
        letters:{
          A:{ img:'https://www.dropbox.com/scl/fi/0usq54wcnquoxgk34kcp1/1.jpg?rlkey=1am5x4y7igg2sur5sfkd98p8d&dl=1', items:['瞳はブラックやダークブラウン','白目と黒目のコントラストがはっきりしている','キリっとした印象の目'] },
          B:{ img:'https://www.dropbox.com/scl/fi/9gtol6hril375v7tc9rwk/2.jpg?rlkey=81p9ej8dwhvc8g41r6bqdf259&dl=1', items:['瞳はソフトなブラックやソフトなブラウン','白目と黒目のコントラストは強くない','落ち着いた印象の目'] },
          C:{ img:'https://www.dropbox.com/scl/fi/hei8cgewx19dhlyqcky2c/3.jpg?rlkey=wc1crb3lzazmtxhgmencjpjxm&dl=1', items:['瞳はダークブラウンやブラック','白目はやや黄みが買っている','落ち着いた印象の目'] },
          D:{ img:'https://www.dropbox.com/scl/fi/c0zzki09knylcuuruc9q0/4.jpg?rlkey=485y6gnvfm42na79txf9z5ew2&dl=1', items:['瞳は明るいブラウンやソフトなブラック','白目と黒目の印象がはっきりしている','キラキラとした印象の目'] }
        }
      },
      { id:'accessories', title:'Ⅳ 肌になじむアクセサリーは？',
        letters:{
          A:{ img:'https://www.dropbox.com/scl/fi/w248luwyl0owlu9ydv81j/1.jpg?rlkey=ie9b5nyek4x7yjecy3geypy78&dl=1', items:['ツヤのあるシルバーやプラチナ','ダイヤモンド、ブラックパール','キラキラと光を放つデザイン'] },
          B:{ img:'https://www.dropbox.com/scl/fi/dz3jnf10yk449k43mx1ww/2.jpg?rlkey=p5iz8q6a84v766lgvwr1q3z1g&dl=1', items:['優しい光沢のシルバーやプラチナ','パール、クリスタル','細めのものや繊細なデザイン'] },
          C:{ img:'https://www.dropbox.com/scl/fi/8s2y5regts7if6uyevy4g/3.jpg?rlkey=zg6b21xvth3j66zioymq5v83u&dl=1', items:['黄みの強いゴールド','マットなゴールドやブロンズ','重厚感がある大ぶりのデザイン'] },
          D:{ img:'https://www.dropbox.com/scl/fi/ugpsqc1r4qwd12t4jkovk/4.jpg?rlkey=0k51y59rnueildllr4fvmh1pl&dl=1', items:['キラキラした明るいゴールド','イエローゴールド、ピンクゴールド','華奢で可愛らしいデザイン'] }
        }
      },
      { id:'hair', title:'Ⅴ 髪の色・質感は？',
        letters:{
          A:{ img:'https://www.dropbox.com/scl/fi/fwu7w2ak26443gra3ls2z/1.jpg?rlkey=4k63kx81740etoc4lwg8kzoie&dl=1', items:['こげ茶〜黒','つやつやの黒髪'] },
          B:{ img:'https://www.dropbox.com/scl/fi/5e1mz1oa967zvylewz1lm/2.jpg?rlkey=2nflm6hqr11a79fxn2imysn21&dl=1', items:['こげ茶〜グレーよりの黒','ソフトな黒髪'] },
          C:{ img:'https://www.dropbox.com/scl/fi/b1tzf8fd32guwl9ks9p5c/3.jpg?rlkey=bz12txiwppxk67akupele9pn6&dl=1', items:['やわらかいブラウン～黒に近いブラウン','ややマットな質感'] },
          D:{ img:'https://www.dropbox.com/scl/fi/s0eaur7gilj0mzjdt730l/4.jpg?rlkey=bq6ttfksib5czszt7uv7oy70b&dl=1', items:['明るいブラウン','絹糸のようなツヤがある'] }
        }
      }
    ];

    /* ========= 軽量プリロード（現在＋次のみ） ========= */
    function preloadSectionImages(step){
      const sec = SECTIONS[step]; if(!sec) return;
      const urls = [];
      for(const k of ['A','B','C','D']){ const L=sec.letters[k]; if(L?.img) urls.push(L.img); }
      urls.forEach(u=>{ const img=new Image(); img.decoding='async'; img.loading='eager'; img.src=u; });
    }
    function preloadResultImagesIdle(){
      const run=()=>{ Object.values(RESULT_IMAGES).forEach(u=>{ const img=new Image(); img.decoding='async'; img.loading='lazy'; img.src=u; }); };
      if('requestIdleCallback' in window){ requestIdleCallback(run, {timeout:1200}); } else { setTimeout(run, 400); }
    }

    /* ========= 状態 ========= */
    const state = { step: 0, checks: loadSavedChecks() || {} };
    let lastResultCache = null;

    document.addEventListener('DOMContentLoaded', () => {
      render();
      preloadSectionImages(state.step);
      if (SECTIONS[state.step+1]) { setTimeout(()=>preloadSectionImages(state.step+1), 300); }
    });

    function saveChecks(){ try{ localStorage.setItem('pc_checks', JSON.stringify(state.checks)); }catch(e){} }
    function loadSavedChecks(){ try{ return JSON.parse(localStorage.getItem('pc_checks')||'{}'); }catch(e){ return {}; } }
    function clearSavedChecks(){ try{ localStorage.removeItem('pc_checks'); }catch(e){} }

    /* ========= UI描画 ========= */
    function render(){
      const sec = SECTIONS[state.step];
      const root = document.getElementById('questionView');
      root.innerHTML = `<div class='section-title'>${sec.title}</div>`;
      const grid = document.createElement('div'); grid.className='grid-letters';

      for(const l of ['A','B','C','D']){
        const L = sec.letters[l];
        const box = document.createElement('div'); box.className='letter-box';
        const head = document.createElement('div'); head.className='letter-head';
        let icon='';
        if(L.img){
          icon = `<span class='icon-img'><img src='${L.img}' alt='' loading="lazy" decoding="async"></span>`;
        }else{
          icon = `<span class='swatch' style='background:${L.swatch}'></span>`;
        }
        head.innerHTML = `<span class='letter-badge'>${l}</span>${icon}`;
        box.appendChild(head);

        L.items.forEach((it,i)=>{
          const id=`${sec.id}-${l}-${i}`;
          const checked=!!(state.checks[sec.id]?.[l]?.[i]);
          const label=document.createElement('label'); label.className='check';
          label.innerHTML = `<input type='checkbox' id='${id}' ${checked?'checked':''}><span>${it}</span>`;
          const input=label.querySelector('input');
          input.addEventListener('change',(e)=>{
            state.checks[sec.id]=state.checks[sec.id]||{};
            state.checks[sec.id][l]=state.checks[sec.id][l]||{};
            state.checks[sec.id][l][i]=e.target.checked;
            saveChecks();
            updateNextBtnState();
          });
          box.appendChild(label);
        });
        grid.appendChild(box);
      }

      root.appendChild(grid);
      renderStepper();
      updateNextBtnLabel();
      updateNextBtnState();
      toggleResult(false);
      requestAnimationFrame(updateNextBtnState);
    }

    function renderStepper(){
      const holder = document.getElementById('stepper');
      const total = SECTIONS.length;
      const left = document.createElement('div');
      left.className = 'stepper-left';
    
      for(let i=0;i<total;i++){
        const btn = document.createElement('button');
        btn.type='button';
        btn.className = 'num' + (i < state.step ? ' done' : i === state.step ? ' active' : '');
        btn.textContent = (i+1);
    
        const isFuture = i > state.step;
        btn.disabled = isFuture;                  // ← 未来は押せない
        if (isFuture) btn.classList.add('locked'); // ← 見た目を半透明グレーに
        btn.setAttribute('aria-label', `ステップ ${i+1}${i===state.step?'（現在地）':''}`);
        btn.title = isFuture ? 'このステップはまだ進めません' : `ステップ ${i+1} へ移動`;
    
        btn.onclick = () => {
          if (!isFuture) { state.step = i; render(); }
        };
        left.appendChild(btn);
      }
    
      const right = document.createElement('div');
      right.className = 'stepper-right';
      right.textContent = `STEP ${state.step+1} / ${total}`;
    
      holder.innerHTML = '';
      holder.appendChild(left);
      holder.appendChild(right);
    }

    function toggleResult(show){
      document.getElementById('resultView').style.display = show ? 'block':'none';
      document.getElementById('questionView').style.display = show ? 'none':'block';
      const nav = document.getElementById('navBar');
      if(nav) nav.style.display = show ? 'none':'block';
    }

    function updateNextBtnLabel(){
      const nextBtn=document.getElementById('btnNext');
      const isLast = state.step === SECTIONS.length-1;
      nextBtn.textContent = isLast ? '結果を確認' : '次へ';
      nextBtn.setAttribute('aria-label', isLast ? '結果を確認' : '次へ');
    }

    function sectionHasAnyChecked(stepIndex){
      const sec=SECTIONS[stepIndex], secChecks=state.checks[sec.id]||{};
      for(const l of ['A','B','C','D']){ const idxs=secChecks[l]||{}; for(const k in idxs){ if(idxs[k]) return true; } }
      const inputs=document.querySelectorAll("#questionView input[type='checkbox']"); for(const el of inputs){ if(el.checked) return true; }
      return false;
    }

    function updateNextBtnState(){
      const nextBtn=document.getElementById('btnNext');
      nextBtn.disabled = !sectionHasAnyChecked(state.step);
    }

    /* ========= 操作 ========= */
    document.getElementById('btnNext').onclick = () => {
      if (!sectionHasAnyChecked(state.step)) return;
      if (state.step < SECTIONS.length - 1){
        state.step++; render();
        preloadSectionImages(state.step);
        if (SECTIONS[state.step+1]) { setTimeout(()=>preloadSectionImages(state.step+1), 200); }
        if (state.step >= SECTIONS.length - 2) { preloadResultImagesIdle(); }
      } else {
        const result = computeResult(); showResult(result);
      }
    };
    document.getElementById('btnPrev').onclick = () => { if(state.step>0){ state.step--; render(); } };
    document.getElementById('btnRestart').onclick = () => {
      state.step=0; state.checks={}; clearSavedChecks(); lastResultCache=null; render();
      window.scrollTo({top:0, behavior:'smooth'});
    };

    /* ========= LIFF（画像のみ送信） ========= */
    async function ensureLiffReady(){
      if (!window.liff) await loadScript('https://static.line-scdn.net/liff/edge/2/sdk.js');
      const LIFF_ID='2008350729-NwPdmMA7'; // ←必要に応じて置き換え
      if (liff && !liff._initCalled && LIFF_ID){
        try{ await liff.init({ liffId: LIFF_ID }); }catch(e){}
      }
    }
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script'); s.src=src; s.async=true; s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
      });
    }

    document.getElementById('btnShareLine').onclick = async () => {
      await ensureLiffReady();
      const { image } = lastResultCache || computeResult();
      if (!image){ alert('画像が用意できませんでした。'); return; }
      try{
        if (window.liff?.isLoggedIn?.()) {
          if (liff.shareTargetPicker) {
            await liff.shareTargetPicker([{ type:'image', originalContentUrl:image, previewImageUrl:image }]);
          } else {
            await liff.sendMessages([{ type:'image', originalContentUrl:image, previewImageUrl:image }]);
          }
          alert('結果画像をLINEに送信しました。');
        } else if (window.liff){ await liff.login(); }
        else { alert('LINE連携（LIFF）が有効ではありません。liffIdの設定をご確認ください。'); }
      }catch(e){ console.error(e); alert('LINE送信でエラーが発生しました。'); }
    };

    /* ========= 判定（画像のみ返す） ========= */
    function computeResult(){
      const letterCounts={A:0,B:0,C:0,D:0}, sectionByLetter={};
      for(const sec of SECTIONS){
        const secChecks=state.checks[sec.id]||{}, local={A:0,B:0,C:0,D:0};
        for(const l of ['A','B','C','D']){ const idxs=secChecks[l]||{}; for(const k in idxs){ if(idxs[k]){ letterCounts[l]++; local[l]++; } } }
        const maxLocal=Math.max(local.A,local.B,local.C,local.D);
        const winners=['A','B','C','D'].filter(l=>local[l]===maxLocal && maxLocal>0);
        winners.forEach(l=>{ sectionByLetter[l]=(sectionByLetter[l]||0)+1; });
      }
      const order=['D','B','C','A'];
      let topCount=Math.max(letterCounts.A,letterCounts.B,letterCounts.C,letterCounts.D);
      let candidate=order.find(l=>letterCounts[l]===topCount)||'D';
      const tied=['A','B','C','D'].filter(l=>letterCounts[l]===topCount);
      if(tied.length>1){
        let best=candidate, bestScore=sectionByLetter[best]||0;
        for(const l of tied){ const s=sectionByLetter[l]||0;
          if(s>bestScore || (s===bestScore && order.indexOf(l)<order.indexOf(best))){ best=l; bestScore=s; }
        }
        candidate=best;
      }
      const season=LETTER_TO_SEASON[candidate], image=RESULT_IMAGES[season];
      const result={letter:candidate, season, image};
      lastResultCache=result; return result;
    }

    function showResult({ image }){
      const hero=document.getElementById('heroImg');
      if(image){
        const img=new Image(); img.decoding='async'; img.loading='eager';
        img.onload=()=>{ img.style.opacity='1'; };
        img.style.opacity='0'; img.style.transition='opacity .25s ease';
        img.alt='診断結果画像'; img.src=image;
        hero.innerHTML=''; hero.appendChild(img); hero.setAttribute('aria-hidden','false');
      }else{
        hero.innerHTML=''; hero.setAttribute('aria-hidden','true');
      }
      toggleResult(true);
      renderStepper();
    }
  </script>
</body>
</html>
