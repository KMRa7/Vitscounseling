<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>パーソナルカラー簡易診断｜ステップ式</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#df9b9b; --brand-100:#fff1f1; --brand-200:#ffe2e2; --brand-300:#f6c8c8;
      --radius:16px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    body{margin:0; font-family:'Inter','Noto Sans JP',sans-serif; background:linear-gradient(180deg,var(--bg) 0%,#fff 100%); color:var(--ink)}
    .wrap{max-width:860px; margin:0 auto; padding:20px 16px 120px}
    .card{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; position:relative}
    .card::before{content:""; position:absolute; inset:0 0 auto 0; height:6px; background:linear-gradient(90deg,var(--brand-200),var(--brand-300)); border-radius:16px 16px 0 0}
    h1{margin:10px 0 6px; font-size:clamp(22px,3.4vw,28px)}
    .lead{color:var(--muted); margin:0 0 14px; font-size:14px}
    .stepper{display:flex; gap:8px; align-items:center; margin:6px 0 14px}
    .dot{width:10px; height:10px; border-radius:50%; background:#e2e8f0; border:1px solid #cbd5e1}
    .dot.active{background:var(--brand); border-color:var(--brand)}
    .section-title{font-weight:700; font-size:16px; margin:10px 0 12px}
    .grid-letters{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .letter-box{border:1px solid var(--line); border-radius:14px; padding:14px; background:#fff}
    .letter-head{display:flex; align-items:center; gap:10px; margin-bottom:10px}
    .letter-badge{display:inline-grid; place-items:center; width:28px; height:28px; border-radius:10px; background:#f1f5f9; border:1px solid #e2e8f0; font-weight:700}
    .icon-img{width:80px; height:80px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; display:inline-grid; place-items:center; overflow:hidden}
    .icon-img img{width:100%; height:100%; object-fit:contain}
    .swatch{width:28px; height:28px; border-radius:8px; border:1px solid #e5e7eb}
    .check{display:flex; gap:10px; align-items:flex-start; margin:8px 0}
    .check input{margin-top:3px; width:18px; height:18px}
    .result{display:none; margin-top:12px}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid var(--line); margin:4px 6px 0 0; font-size:12px}
    .summary{background:#fff; border:1px dashed var(--brand-300); border-radius:12px; padding:12px; white-space:pre-wrap; font-size:13px}
    .hero-img{margin-top:12px; border-radius:14px; border:1px solid var(--line); overflow:hidden}
    .hero-img img{width:100%; height:auto; display:block}
    .nav{display:flex; gap:10px; margin-top:16px; flex-wrap:wrap}
    .btn{cursor:pointer; min-height:44px; padding:12px 16px; border-radius:12px; border:1px solid var(--line); background:#fff; font-weight:700}
    .btn.primary{background:linear-gradient(180deg,var(--brand),#c57f7f); color:#fff; border-color:#c57f7f}
    .footer-cta{position:fixed; left:0; right:0; bottom:0; padding:10px 12px; background:rgba(255,255,255,.9); border-top:1px solid var(--line); box-shadow:0 -10px 30px rgba(15,23,42,.06)}
    .footer-cta .btn{width:100%}
    @media (max-width:640px){.grid-letters{grid-template-columns:1fr}}
  </style>
  <!-- LIFF SDK（LINE送信用） -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <main class="wrap">
    <section class="card" id="app" aria-live="polite">
      <h1>パーソナルカラー簡易診断（ステップ式）</h1>
      <p class="lead">各ステップで <b>A/B/C/D</b> の中から<strong>複数チェック可</strong>。すべて回答後にタイプ判定します。</p>

      <div class="stepper" id="stepper"></div>
      <div id="questionView"></div>

      <div class="result" id="resultView">
        <h2>診断結果</h2>
        <div id="typeBadge" class="badge"></div>
        <div class="hero-img" id="heroImg" aria-hidden="true"></div>
        <div class="summary" id="summaryBox"></div>
        <div class="nav">
          <button class="btn" id="btnRestart">やり直す</button>
          <button class="btn primary" id="btnShareLine">結果をLINEで送る</button>
          <button class="btn" id="btnCopy">結果をコピー</button>
        </div>
      </div>

      <div class="nav" id="navBtns">
        <button class="btn" id="btnPrev">戻る</button>
        <button class="btn primary" id="btnNext">次へ</button>
      </div>
    </section>
  </main>

  <script>
    /* ===================== 設定 ===================== */
    // A=WINTER, B=SUMMER, C=AUTUMN, D=SPRING の想定でマッピング
    const LETTER_TO_SEASON = { A: 'WINTER', B: 'SUMMER', C: 'AUTUMN', D: 'SPRING' };

    // 結果ごとの大きい画像URL（差し替えてOK）
    const RESULT_IMAGES = {
      SPRING: 'https://www.dropbox.com/scl/fi/6x43wuq7lf3s3ppyfpabu/4.png?rlkey=88ju2e5c659hg8fns3u24avvg&st=0w8w8n93&dl=1',
      SUMMER: 'https://www.dropbox.com/scl/fi/9esqh65fomu9za7q43j4k/2.png?rlkey=fj29mxutr611k1j1j9j8szng6&st=1mjkkugb&dl=1',
      AUTUMN: 'https://www.dropbox.com/scl/fi/d4e2z1y2z1s0fzohkrz9c/3.png?rlkey=lcg5lv3z6dcqxi16edcdibgsi&st=if1g716q&dl=1',
      WINTER: 'https://www.dropbox.com/scl/fi/m1iqpihu2dr8q9b4hnru4/1.png?rlkey=ldem7h7sai3fajnw6xfkaz096&st=kxrp5bzb&dl=1',
    };

    // 結果ごとの説明文（必要に応じて編集）
    const RESULT_TEXT = {
      SPRING: 'スプリング（イエベ春）\n・明るく澄んだ色、黄みのある軽やかな色が得意\n・ゴールド、コーラル、アプリコット、ミント等\n・メイクは艶と透明感、黄み寄りのベージュ系が◎',
      SUMMER : 'サマー（ブルベ夏）\n・青みを含んだやわらかい色、くすみパステルが得意\n・ローズ、ラベンダー、ブルーグレー等\n・メイクはソフトマット、ローズ〜モーブ系が◎',
      AUTUMN: 'オータム（イエベ秋）\n・深みと温かみのある色、低明度・低彩度が得意\n・テラコッタ、オリーブ、マスタード等\n・メイクはマット質感、ブラウン・オレンジ系が◎',
      WINTER : 'ウィンター（ブルベ冬）\n・はっきり高彩度＆高コントラストが得意\n・ビビッドピンク、ロイヤルブルー、モノトーン等\n・メイクは艶×コントラスト、青みピンクやボルドーが◎',
    };

    // ステップデータ（元のまま）
    const SECTIONS = [
      {
        id: 'skin',
        title: 'Ⅰ 肌の色・印象は？',
        letters: {
          A: { swatch: '#f2d7c3', items: ['色白、ほおの赤みが少ない', 'やや赤みを帯びている', 'ツヤがある','メナードのファンデーション 22・23・51・52を使用'] },
          B: { swatch: '#f3c7c3', items: ['ピンクベージュ、ピンクみを帯びている', '透けるように白い', 'ツヤが少ない、パウダリーな印象','メナードのファンデーション 22・23・51・52を使用'] },
          C: { swatch: '#e6c39a', items: ['クリーム色、黄みが強い', '赤みがない、くすみがち', '陶器のようななめらかな質感','メナードのファンデーション 41・41Y・44・52Yを使用'] },
          D: { swatch: '#e8dcd1', items: ['アイボリーベージュ、黄みがある', '小麦肌、ツヤがある', '血色がよい、ほほが赤くなりやすい','メナードのファンデーション 41・41Y・44・52Yを使用'] }
        }
      },
      {
        id: 'beigegray',
        title: 'Ⅱ ベージュとグレーの洋服で得意なのは？',
        letters: {
          A: { img: 'https://www.dropbox.com/scl/fi/f45scwhiw1joxcowsg22g/1.png?rlkey=ohm9bn5end0hzocu3ctman2o7&st=ep6qydpt&dl=1', items: ['ダークグレーで印象がはっきり'] },
          B: { img: 'https://www.dropbox.com/scl/fi/0roqzj9g4cadbc7d79c4s/2.png?rlkey=gp833m25rql6cavmt3i9a3vnw&st=g3gbctrk&dl=1', items: ['明るいグレーで肌がキレイ'] },
          C: { img: 'https://www.dropbox.com/scl/fi/6gn3quc7n0tuepa3yjtht/3.png?rlkey=r94s81ov3cxq93o4n0q8j9ujo&st=lciqbt9s&dl=1', items: ['落ち着いたベージュでも老けない'] },
          D: { img: 'https://www.dropbox.com/scl/fi/88bit1bexy12jwjy6vtz1/4.png?rlkey=m0j9ykut4940c7b85o2qmr2c1&st=3mwnariv&dl=1', items: ['明るいベージュで顔色が良い'] }
        }
      },
      {
        id: 'eyes',
        title: 'Ⅲ 瞳の色・印象は？',
        letters: {
          A: { img: 'https://www.dropbox.com/scl/fi/0usq54wcnquoxgk34kcp1/1.jpg?rlkey=1am5x4y7igg2sur5sfkd98p8d&st=2j73i395&dl=1', items: ['黒やダークブラウン', 'コントラストが強い'] },
          B: { img: 'https://www.dropbox.com/scl/fi/9gtol6hril375v7tc9rwk/2.jpg?rlkey=81p9ej8dwhvc8g41r6bqdf259&st=qf5kznil&dl=1', items: ['ソフトブラック', 'やさしい印象'] },
          C: { img: 'https://www.dropbox.com/scl/fi/hei8cgewx19dhlyqcky2c/3.jpg?rlkey=wc1crb3lzazmtxhgmencjpjxm&st=lh1utd1f&dl=1', items: ['ダークブラウン', '落ち着いた印象'] },
          D: { img: 'https://www.dropbox.com/scl/fi/c0zzki09knylcuuruc9q0/4.jpg?rlkey=485y6gnvfm42na79txf9z5ew2&st=u3d404nn&dl=1', items: ['明るいブラウン', 'キラキラした印象'] }
        }
      },
      {
        id: 'accessories',
        title: 'Ⅳ 肌になじむアクセサリーは？',
        letters: {
          A: { img: 'https://www.dropbox.com/scl/fi/w248luwyl0owlu9ydv81j/1.jpg?rlkey=ie9b5nyek4x7yjecy3geypy78&st=do16zlfw&dl=1', items: ['ツヤのあるシルバー'] },
          B: { img: 'https://www.dropbox.com/scl/fi/dz3jnf10yk449k43mx1ww/2.jpg?rlkey=p5iz8q6a84v766lgvwr1q3z1g&st=sptec8rp&dl=1', items: ['優しい光沢のシルバー', 'パールやクリスタル'] },
          C: { img: 'https://www.dropbox.com/scl/fi/8s2y5regts7if6uyevy4g/3.jpg?rlkey=zg6b21xvth3j66zioymq5v83u&st=7om2etqo&dl=1', items: ['落ち着いたゴールド', '大ぶりのデザイン'] },
          D: { img: 'https://www.dropbox.com/scl/fi/ugpsqc1r4qwd12t4jkovk/4.jpg?rlkey=0k51y59rnueildllr4fvmh1pl&st=8ljuejk6&dl=1', items: ['明るいゴールド', '細身で華やか'] }
        }
      },
      {
        id: 'hair',
        title: 'Ⅴ 髪の色・質感は？',
        letters: {
          A: { img: 'https://www.dropbox.com/scl/fi/fwu7w2ak26443gra3ls2z/1.jpg?rlkey=4k63kx81740etoc4lwg8kzoie&st=9ylv0jfp&dl=1', items: ['こげ茶〜黒', 'ツヤのある髪'] },
          B: { img: 'https://www.dropbox.com/scl/fi/5e1mz1oa967zvylewz1lm/2.jpg?rlkey=2nflm6hqr11a79fxn2imysn21&st=1suf9fik&dl=1', items: ['こげ茶〜グレー寄り', 'ソフトな黒髪'] },
          C: { img: 'https://www.dropbox.com/scl/fi/b1tzf8fd32guwl9ks9p5c/3.jpg?rlkey=bz12txiwppxk67akupele9pn6&st=9nr50rjt&dl=1', items: ['やわらかブラウン', 'マット質感'] },
          D: { img: 'https://www.dropbox.com/scl/fi/s0eaur7gilj0mzjdt730l/4.jpg?rlkey=bq6ttfksib5czszt7uv7oy70b&st=4qxbplc8&dl=1', items: ['明るいブラウン', '絹のようなツヤ'] }
        }
      }
    ];

    function getAllImageUrls() {
      const urls = new Set();
      // セクション内の画像
      SECTIONS.forEach(sec => {
        ['A','B','C','D'].forEach(k => {
          const L = sec.letters[k];
          if (L && L.img) urls.add(L.img);
        });
      });
      // 結果用の大きい画像
      Object.values(RESULT_IMAGES || {}).forEach(u => u && urls.add(u));
      return Array.from(urls);
    }

    function preloadImages(urls, {addPreloadLinks = true} = {}) {
      // rel=preload も張る（対応ブラウザで優先度アップ）
      if (addPreloadLinks) {
        urls.forEach(u => {
          try {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'image';
            link.href = u;
            document.head.appendChild(link);
          } catch(e) {}
        });
      }
      // Image() で実体プリロード
      return Promise.all(urls.map(u => new Promise(resolve => {
        const img = new Image();
        img.onload = img.onerror = () => resolve();
        img.src = u;
      })));
    }

    /* ===================== 状態 ===================== */
    const state = { step: 0, checks: loadSavedChecks() || {} };

    document.addEventListener('DOMContentLoaded', async () => {
      // 先にプリロード開始（待っても待たなくてもOK）
      const allUrls = getAllImageUrls();
      const preloadPromise = preloadImages(allUrls);

      // 先にUIは描画（体感を軽く）、裏でプリロード進行
      render();

      // 可能なら初回ステップに関連する画像を優先して待機（任意）
      try { await Promise.race([preloadPromise, new Promise(r => setTimeout(r, 800))]); } catch(e){}

      // LIFF初期化（使っている場合だけ）
      try { await initLiff(); } catch(e) {}
    });

    function saveChecks(){ localStorage.setItem('pc_checks', JSON.stringify(state.checks)); }

    function clearSavedChecks(){
      try { localStorage.removeItem('pc_checks'); } catch(e){}
    }

    function sectionHasAnyChecked(stepIndex){
      const sec = SECTIONS[stepIndex];
      const secChecks = state.checks[sec.id] || {};
      // stateベースで確認
      for (const l of ['A','B','C','D']){
        const idxs = secChecks[l] || {};
        for (const k in idxs){ if (idxs[k]) return true; }
      }
      // 念のためDOM側も確認（state同期漏れ対策）
      const root = document.getElementById('questionView');
      if (root){
        const inputs = root.querySelectorAll("input[type='checkbox']");
        for (const el of inputs){ if (el.checked) return true; }
      }
      return false;
    }

    function loadSavedChecks(){
      try{ return JSON.parse(localStorage.getItem('pc_checks')||'{}'); }catch(e){ return {}; }
    }

    /* ===================== 画面描画 ===================== */
    function render() {
      const sec = SECTIONS[state.step];
      const root = document.getElementById('questionView');
      root.innerHTML = `<div class='section-title'>${sec.title}</div>`;
      const grid = document.createElement('div');
      grid.className = 'grid-letters';

      for (const l of ['A','B','C','D']) {
        const L = sec.letters[l];
        const box = document.createElement('div');
        box.className = 'letter-box';
        const head = document.createElement('div');
        head.className = 'letter-head';

        const icon = L.img
          ? `<span class='icon-img'><img src='${L.img}' alt=''></span>`
          : `<span class='swatch' style='background:${L.swatch}'></span>`;

        head.innerHTML = `<span class='letter-badge'>${l}</span>${icon}`;
        box.appendChild(head);

        L.items.forEach((it, i) => {
          const id = `${sec.id}-${l}-${i}`;
          const checked = !!(state.checks[sec.id]?.[l]?.[i]);
          const label = document.createElement('label');
          label.className = 'check';
          label.innerHTML = `<input type='checkbox' id='${id}' ${checked?'checked':''}><span>${it}</span>`;
          label.querySelector('input').addEventListener('change', (e)=>{
            state.checks[sec.id] = state.checks[sec.id] || {};
            state.checks[sec.id][l] = state.checks[sec.id][l] || {};
            state.checks[sec.id][l][i] = e.target.checked;
            saveChecks();
          });
          box.appendChild(label);
        });

        grid.appendChild(box);
      }

      const isLast = state.step === SECTIONS.length - 1;
      const nextBtn = document.getElementById('btnNext');
      if (nextBtn) {
        nextBtn.textContent = isLast ? '結果を確認' : '次へ';
        nextBtn.setAttribute('aria-label', isLast ? '結果を確認' : '次へ');
      }
      root.appendChild(grid);
      renderStepper();
      toggleResult(false);
    }

    function renderStepper(){
      const s = document.getElementById('stepper');
      s.innerHTML = SECTIONS.map((_, i)=>`<div class='dot ${i<=state.step?'active':''}'></div>`).join('');
    }

    function toggleResult(show){
      document.getElementById('resultView').style.display = show ? 'block' : 'none';
      document.getElementById('questionView').style.display = show ? 'none' : 'block';
      // ▼結果ページではナビ（戻る／次へ）を隠す
      const nav = document.getElementById('navBtns');
      if (nav) nav.style.display = show ? 'none' : 'flex';
    }

    /* ===================== 操作 ===================== */
    document.getElementById('btnNext').onclick = () => {
      // 現在のステップに1つもチェックが無ければ進行不可
      if (!sectionHasAnyChecked(state.step)) {
        alert('各ステップで少なくとも1つはチェックしてください。');
        return;
      }

      if (state.step < SECTIONS.length - 1) {
        state.step++;
        render();
      } else {
        // 最終ステップ（結果を確認）でも再チェック
        if (!sectionHasAnyChecked(state.step)) {
          alert('各ステップで少なくとも1つはチェックしてください。');
          return;
        }
        const result = computeResult();
        showResult(result);
      }
    };

    document.getElementById('btnPrev').onclick = () => { if (state.step>0){ state.step--; render(); } };
    document.getElementById('btnRestart').onclick = () => {
      state.step = 0;
      state.checks = {};
      clearSavedChecks();  // ← localStorageごと削除
      lastResultCache = null;
      render();
    };

    document.getElementById('btnCopy').onclick = () => {
      const { season, letter, counts, summary } = lastResultCache || computeResult();
      const text = buildShareText(season, letter, counts, summary);
      navigator.clipboard.writeText(text).then(()=>alert('結果をコピーしました。')).catch(()=>alert('コピーに失敗しました。'));
    };

    document.getElementById('btnShareLine').onclick = async () => {
      const { season, letter, counts, summary, image } = lastResultCache || computeResult();
      const text = buildShareText(season, letter, counts, summary);
      try{
        if (window.liff?.isLoggedIn?.()) {
          // 可能ならシェアターゲットピッカー
          if (liff.shareTargetPicker) {
            await liff.shareTargetPicker([{ type:'text', text }, ...(image? [{type:'image', originalContentUrl:image, previewImageUrl:image}] : []) ]);
          } else {
            await liff.sendMessages([{ type:'text', text }]);
          }
          alert('LINEに送信しました。');
        } else if (window.liff){
          await liff.login();
        } else {
          alert('LINE連携（LIFF）が有効ではありません。liffIdの設定をご確認ください。');
        }
      }catch(e){
        console.error(e);
        alert('LINE送信でエラーが発生しました。コンソールを確認してください。');
      }
    };

    /* ===================== 判定ロジック ===================== */
    let lastResultCache = null;

    function computeResult(){
      // 各セクションで選ばれた A/B/C/D のチェック数を集計
      const letterCounts = { A:0, B:0, C:0, D:0 };
      const sectionByLetter = {}; // 各セクションでどれが多かったか（タイブレーク用）
      for (const sec of SECTIONS){
        const secChecks = state.checks[sec.id] || {};
        const local = { A:0, B:0, C:0, D:0 };
        for (const l of ['A','B','C','D']){
          const idxs = secChecks[l] || {};
          for (const k in idxs){ if (idxs[k]){ letterCounts[l]++; local[l]++; } }
        }
        // そのセクションで最大のレターを記録
        const maxLocal = Math.max(local.A, local.B, local.C, local.D);
        const winners = ['A','B','C','D'].filter(l=>local[l]===maxLocal && maxLocal>0);
        if (winners.length){
          winners.forEach(l=>{
            sectionByLetter[l] = (sectionByLetter[l]||0) + 1;
          });
        }
      }

      // 総合最多を採用、同数なら D > B > C > A の優先
      const order = ['D','B','C','A'];
      let topCount = Math.max(letterCounts.A, letterCounts.B, letterCounts.C, letterCounts.D);
      let candidate = order.find(l => letterCounts[l] === topCount) || 'D';

      // さらに同数が多い場合は、勝ちセクション数でタイブレーク
      const tiedLetters = ['A','B','C','D'].filter(l=>letterCounts[l]===topCount);
      if (tiedLetters.length>1){
        let best = candidate;
        let bestScore = sectionByLetter[best]||0;
        for (const l of tiedLetters){
          const score = sectionByLetter[l]||0;
          if (score>bestScore || (score===bestScore && order.indexOf(l)<order.indexOf(best))){
            best = l; bestScore = score;
          }
        }
        candidate = best;
      }

      const season = LETTER_TO_SEASON[candidate];
      const summary = RESULT_TEXT[season];
      const image = RESULT_IMAGES[season];

      const result = {
        letter: candidate,
        season,
        counts: {...letterCounts},
        summary,
        image
      };
      lastResultCache = result;
      return result;
    }

    function showResult({ season, letter, counts, summary, image }){
      const badge = document.getElementById('typeBadge');
      badge.textContent = `${season}（${niceJa(season)}） / 判定レター: ${letter}`;

      const hero = document.getElementById('heroImg');
      hero.innerHTML = image ? `<img src="${image}" alt="${niceJa(season)}のイメージ">` : '';
      hero.setAttribute('aria-hidden', image ? 'false' : 'true');

      const detail = [
        `A: ${counts.A} / B: ${counts.B} / C: ${counts.C} / D: ${counts.D}`,
        ``,
        summary
      ].join('\n');
      document.getElementById('summaryBox').textContent = detail;

      toggleResult(true);
      renderStepper();
    }

    function niceJa(season){
      return { SPRING:'イエベ春', SUMMER:'ブルベ夏', AUTUMN:'イエベ秋', WINTER:'ブルベ冬' }[season] || season;
    }

    function buildShareText(season, letter, counts, summary){
      return [
        '【パーソナルカラー診断 結果】',
        `${season}（${niceJa(season)}）／レター: ${letter}`,
        `A:${counts.A} / B:${counts.B} / C:${counts.C} / D:${counts.D}`,
        '',
        summary,
        '',
        '※この結果は簡易診断です。参考としてご活用ください。'
      ].join('\n');
    }

    /* ===================== LIFF 初期化 ===================== */
    async function initLiff(){
      const LIFF_ID = 'YOUR_LIFF_ID'; // ← あなたのLIFF IDに置き換えてください
      if (!LIFF_ID) return;
      if (!window.liff) return;
      if (!liff.isInClient && liff.init) {
        await liff.init({ liffId: LIFF_ID });
      }
    }
  </script>
</body>
</html>
